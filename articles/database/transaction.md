# 트랜잭션

## 트랜잭션은 무엇인가?

### 정의

트랜잭션은 DBMS에서 하나의 논리적 작업 단위를 구성하는 일련의 연산들의 집합을 말한다.

데이터의 정합성을 보장하기 위한 기능이다. 즉, 논리적인 작업 셋을 모두 완벽하게 처리(Commit)하거나, 처리하지 못할 경우에는 원 상태로 복구(Rollback)해서 작업의 일부만 적용되는 현상이 발생하지 않게 만들어주는 기능이다.

### 성질

흔히 트랜잭션은 ACID 성질이라고 하는 다음 네 가지 성질로 설명된다.

- Atomicity(원자성) : 트랜잭션의 모든 연산들이 정상적으로 수행 완료되거나 아니면 전혀 어떠한 연산도 수행되지 않은 상태를 보장해야 한다. 쉽게 ‘all or nothing’ 특성으로 설명된다.
- Consistency(일관성) : 트랜잭션을 수행하기 전이나 후나 데이터베이스는 항상 일관된 상태를 유지해야 한다. 즉, 성공적으로 수행된 트랜잭션은 정당한 데이터들만을 데이터베이스에 반영해야 한다.
- Isolation(독립성) : 여러 트랜잭션이 동시에 수행되더라도 각각의 트랜잭션은 다른 트랜잭션의 수행에 영향을 받지 않고 독립적으로 수행되어야 한다. 즉, 한 트랜잭션의 중간 결과가 다른 트랜잭션에게는 숨겨져야 한다는 의미인데, 이러한 isolation 성질이 보장되지 않으면 트랜잭션이 원래 상태로 되돌아갈 수 없게 된다.
- Durability(지속성) : 트랜잭션이 성공적으로 완료되어 커밋되고 나면, 해당 트랜잭션에 의한 모든 변경은 향후에 어떤 소프트웨어나 하드웨어 장애가 발생되더라도 보존되어야 한다.

### 종료 조건

1. 문제 없이 정상적으로 수행된 경우, 커밋을 통한 종료
2. 잘못된 입력, 일관성 제약 조건 위배 등의 상황이 발생되거나 사용자의 요청에 의해 철회되는 경우
3. 타임 아웃, 교착 상태 등과 같이 시스템이 감지하는 문제로 인한 철회

## 트랜잭션과 잠금(Lock)

잠금(Lock)과 트랜잭션은 서로 비슷한 개념 같지만 사실 잠금은 동시성을 제어하기 위한 기능이고 트랜잭션은 데이터의 정합성을 보장하기 위한 기능이다. 잠금은 여러 커넥션에서 동시에 동일한 자원을 요청할 경우 순서대로 한 시점에는 하나의 커넥션만 변경할 수 있게 해주는 역할을 한다. 여기서 자원은 레코드나 테이블을 말한다. 이와 달리 트랜잭션은 하나의 논리적인 작업 셋 중 하나의 쿼리가 있든 두 개 이상의 쿼리가 있든 관계없이 논리적인 작업 셋 자체가 100% 적용되거나 아무것도 적용되지 않아야 함을 보장하는 것이다.

## 트랜잭션을 사용할 때 주의할 점

트랜잭션은 꼭 필요한 최소의 코드에만 적용하는 것이 좋다. 다시 말해, 프로그램 코드에서 트랜잭션의 범위를 최소화하라는 의미이다. 일반적으로 데이터베이스 커넥션은 개수가 제한적이어서 각 단위 프로그램이 커넥션을 소유하는 시간이 길어질수록 사용 가능한 여유 커넥션의 개수는 줄어들 것이다. 나아가 어느 순간에는 각 단위 프로그램에서 커넥션을 가져가기 위해 기다려야 하는 상황이 발생할 수도 있다.
